**План выполнения Задания 8 – Приложение accounts**

**Цель:** Создание и интеграция базового функционала регистрации, входа и выхода пользователей в Django-проект.

**Необходимые инструменты:**
*   Рабочий Django-проект (вероятно, тот, что был создан в предыдущих заданиях, с приложениями articles, about, homepage и базовым шаблоном `base_layout.html`).
*   Редактор кода.
*   Терминал для запуска команд `manage.py`.
*   Веб-браузер.
*   Аккаунт на GitHub.

**Шаги выполнения:**

1.  **Подготовка проекта:**
    *   Убедитесь, что ваш текущий Django-проект работает корректно.
    *   Убедитесь, что у вас есть базовый шаблон (`base_layout.html` или аналогичный), который будут расширять шаблоны приложения accounts.

2.  **1.1 Создание и подключение приложения `accounts`:**
    *   Откройте терминал в корневой директории вашего проекта.
    *   Выполните команду: `python manage.py startapp accounts`
    *   Откройте файл `settings.py`.
    *   Добавьте `'accounts'` в список `INSTALLED_APPS`.

3.  **1.2 Создание `urls.py` в приложении `accounts`:**
    *   В папке `accounts` создайте новый файл с именем `urls.py`.
    *   Скопируйте в этот файл следующий код (как показано в инструкции):
        ```python
        from django.urls import path
        from . import views

        urlpatterns = [
            path('signup/', views.signup_view, name='signup'),
        ]
        ```
    *   *Примечание:* `. import views` предполагает, что `views.py` находится в той же директории (`accounts`).

4.  **1.3 Подключение URL-адресов приложения `accounts` к главному `urls.py`:**
    *   Откройте файл `mysite/urls.py` (или как называется ваш главный файл urls).
    *   Добавьте `from django.urls import include` в раздел импортов.
    *   Добавьте следующую строку в ваш `urlpatterns` (как показано в инструкции), убедившись, что она находится *перед* универсальными паттернами, если таковые имеются:
        ```python
        path('accounts/', include('accounts.urls')),
        ```
    *   *Примечание:* Убедитесь, что остальные URL-паттерны (для admin, homepage, about, articles) присутствуют и корректны.

5.  **1.4 Добавление функции `signup_view` в `accounts/views.py`:**
    *   Откройте файл `accounts/views.py`.
    *   Добавьте необходимые импорты в начале файла:
        ```python
        from django.shortcuts import render, redirect # redirect удобнее чем HttpResponseRedirect
        from django.contrib.auth.forms import UserCreationForm
        from django.contrib.auth import login # Нужен для автоматического входа после регистрации
        # from django.http import HttpResponseRedirect # Можно использовать redirect вместо этого
        ```
    *   Скопируйте код функции `signup_view` (как показано в инструкции):
        ```python
        def signup_view(request):
            if request.method == 'POST':
                form = UserCreationForm(request.POST)
                if form.is_valid():
                    user = form.save()
                    login(request, user) # Автоматический вход после регистрации
                    return redirect('/articles/') # или как у вас настроен URL для списка статей
            else:
                form = UserCreationForm()
            return render(request, 'accounts/signup.html', {'form': form})
        ```
    *   *Примечание:* Использование `redirect('/articles/')` (предполагая, что `/articles/` - это URL списка статей) является общепринятой практикой вместо прямого `HttpResponseRedirect`. Убедитесь, что URL `'/articles/'` соответствует вашему проекту или используйте `redirect('name_вашего_url_списка_статей')`.

6.  **1.5 Создание шаблона `signup.html`:**
    *   В папке `accounts` создайте структуру директорий `templates/accounts/`.
    *   В папке `accounts/templates/accounts/` создайте файл `signup.html`.
    *   В начале файла `signup.html` добавьте строку для расширения базового шаблона: `{% extends 'base_layout.html' %}` (или имя вашего базового шаблона).
    *   Оберните содержимое шаблона в блок, который замещает контент в базовом шаблоне (например, `{% block content %}`...`{% endblock %}`).
    *   Внутри этого блока скопируйте HTML-код для формы из инструкции 1.5 (используя структуру из 1.8 для добавления CSRF токена сразу):
        ```html
        {% extends 'base_layout.html' %}

        {% block content %}
            <h1>Signup</h1>
            <form class="form" action="/accounts/signup/" method="post">
                {% csrf_token %} {# Добавляем CSRF токен здесь #}
                {{ form }}
                <button type="submit">Sign up</button>
            </form>
        {% endblock %}
        ```
    *   *Примечание:* Убедитесь, что путь в `action="/accounts/signup/"` соответствует вашему настроенному URL.

7.  **1.6 Проверка работы представления `signup_view` (начальная):**
    *   Запустите сервер командой `python manage.py runserver`.
    *   Откройте в браузере адрес `http://127.0.0.1:8000/accounts/signup/`.
    *   Вы должны увидеть страницу с формой регистрации.

8.  **1.7 Скриншот ошибки CSRF:**
    *   *Временно* удалите строку `{% csrf_token %}` из `accounts/templates/accounts/signup.html`.
    *   Обновите страницу `http://127.0.0.1:8000/accounts/signup/`.
    *   Заполните поля формы (любыми тестовыми данными).
    *   Нажмите кнопку "Sign up".
    *   Вы должны получить ошибку "Forbidden (403)" с пояснением про CSRF.
    *   Сделайте **скриншот этой ошибки**.
    *   Верните строку `{% csrf_token %}` обратно в `accounts/templates/accounts/signup.html`.

9.  **1.8 Проверка отправки данных после добавления CSRF:**
    *   Обновите страницу `/accounts/signup/`.
    *   Заполните поля формы реальными тестовыми данными (например, username: `testuser`, password: `password123`, password confirmation: `password123`). **Запомните этот логин и пароль.**
    *   Нажмите "Sign up".
    *   Если все настроено правильно, вы должны быть перенаправлены на страницу `/articles/` (или куда настроен редирект). Регистрация должна пройти успешно.

10. **1.9 Фиксация результата регистрации и скриншот списка пользователей в админке:**
    *   Вы должны были успешно зарегистрировать тестового пользователя в предыдущем шаге.
    *   Теперь зайдите в административную панель Django по адресу `http://127.0.0.1:8000/admin/`.
    *   Войдите, используя учетные данные суперпользователя, которые вы создавали ранее (не тестового пользователя).
    *   В админке найдите раздел "Authentication and Authorization" и перейдите в "Users".
    *   Вы должны увидеть в списке вашего тестового пользователя (`testuser` или как вы его назвали).
    *   Сделайте **скриншот списка пользователей в админке**, показывающий вашего тестового пользователя.

11. **1.10 Добавление URL-адресов для login и logout:**
    *   Откройте файл `accounts/urls.py`.
    *   Добавьте необходимые импорты: `from django.contrib.auth import views as auth_views` (или импортируйте `login_view` и `logout_view` из `. import views` после их создания, как показано в инструкции 1.11. Давайте следовать инструкции 1.11 и импортировать их из `. import views` после того, как мы их напишем).
    *   Добавьте новые URL-паттерны в список `urlpatterns`:
        ```python
        from django.urls import path
        from . import views # Импортируем наши представления

        urlpatterns = [
            path('signup/', views.signup_view, name='signup'),
            path('login/', views.login_view, name='login'), # Добавляем URL для входа
            path('logout/', views.logout_view, name='logout'), # Добавляем URL для выхода
        ]
        ```

12. **1.11 Создание функций `login_view` и `logout_view`:**
    *   Откройте файл `accounts/views.py`.
    *   Добавьте необходимые импорты:
        ```python
        from django.shortcuts import render, redirect
        from django.contrib.auth.forms import UserCreationForm, AuthenticationForm # Импорт AuthenticationForm
        from django.contrib.auth import login, logout # Импорт login и logout
        ```
    *   Скопируйте код функций `login_view` и `logout_view` (как показано в инструкции):
        ```python
        def login_view(request):
            if request.method == 'POST':
                form = AuthenticationForm(data=request.POST) # Используем data=request.POST для AuthenticationForm
                if form.is_valid():
                    user = form.get_user() # Получаем пользователя из формы
                    login(request, user)
                    return redirect('/articles/') # Редирект после успешного входа
            else:
                form = AuthenticationForm()
            return render(request, 'accounts/login.html', {'form': form})

        def logout_view(request):
            if request.method == 'POST': # Выход часто обрабатывается POST запросом из формы
                logout(request)
                return redirect('/') # Редирект после выхода (например, на главную)
            # Можно также добавить обработку GET, если хотите ссылку для выхода, но форма безопаснее для logout
            return redirect('/') # Редирект даже если это не POST, просто чтобы не показывать пустую страницу
        ```
    *   *Примечание:* Редирект после logout может быть на любую страницу, например, на главную `/`. Убедитесь, что пути редиректа соответствуют вашему проекту.

13. **1.12 Создание шаблона `login.html`:**
    *   В папке `accounts/templates/accounts/` создайте файл `login.html`.
    *   Добавьте строку для расширения базового шаблона: `{% extends 'base_layout.html' %}`.
    *   Оберните содержимое в блок контента: `{% block content %}`...`{% endblock %}`.
    *   Скопируйте HTML-код для формы входа (как показано в инструкции), добавив `{% csrf_token %}`:
        ```html
        {% extends 'base_layout.html' %}

        {% block content %}
            <h1>Login</h1>
            <form class="form" action="/accounts/login/" method="post">
                {% csrf_token %}
                {{ form }}
                <button type="submit">Login</button>
            </form>
        {% endblock %}
        ```
    *   *Примечание:* Убедитесь, что путь в `action="/accounts/login/"` соответствует вашему настроенному URL.

14. **1.13 Добавление ссылок/форм login/logout в навигацию (базовый шаблон):**
    *   Откройте файл вашего базового шаблона (`base_layout.html`).
    *   Найдите место для навигации (например, `<nav>`).
    *   Вставьте следующий Django template code (как показано в инструкции) туда, где хотите отображать ссылку/форму входа/выхода:
        ```html
        <nav>
            <ul>
                {# Другие пункты меню, если есть #}
                <li><a href="/">Главная</a></li>
                <li><a href="/about/">О нас</a></li>
                <li><a href="/articles/">Статьи</a></li>
                {% if user.is_authenticated %}
                    {# Если пользователь авторизован, показываем форму выхода #}
                    <li>
                        <form class="form" action="/accounts/logout/" method="post">
                            {% csrf_token %}
                            <button type="submit">Logout</button>
                        </form>
                    </li>
                {% else %}
                    {# Если пользователь не авторизован, показываем ссылку для входа #}
                    <li>
                        <a href="{% url 'login' %}">Login</a>
                    </li>
                    {# Опционально: добавить ссылку на регистрацию #}
                    <li>
                         <a href="{% url 'signup' %}">Signup</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        ```
    *   *Примечание:* Убедитесь, что `{% url 'login' %}` и `{% url 'signup' %}` правильно разрешаются на основе имен ваших URL-паттернов. Также убедитесь, что `action` в форме выхода (`/accounts/logout/`) корректен. Вам также может потребоваться настроить `LOGIN_REDIRECT_URL` и `LOGOUT_REDIRECT_URL` в `settings.py` для стандартного поведения Django, но в этой задаче редиректы обрабатываются прямо в представлениях.

15. **1.14 Проверка работы login/logout и скриншоты:**
    *   Убедитесь, что сервер запущен.
    *   Откройте `/accounts/login/`. Сделайте **скриншот страницы входа**.
    *   Войдите, используя учетные данные тестового пользователя, созданного ранее.
    *   Вы должны быть перенаправлены на `/articles/`. Сделайте **скриншот страницы `/articles/`**, убедившись, что в навигации появилась кнопка "Logout".
    *   Нажмите кнопку "Logout".
    *   Вы должны быть перенаправлены на главную страницу `/`. Сделайте **скриншот страницы после выхода**, убедившись, что в навигации появилась ссылка "Login".
    *   Попробуйте войти в админ-панель (`/admin/`) используя учетные данные *тестового пользователя*.
    *   Сделайте **скриншот страницы ошибки админ-панели**, если тестовый пользователь не является персоналом/суперпользователем (что, скорее всего, так).

16. **1.15 Написание стилей и наполнение представлений:**
    *   Создайте или используйте существующие статические файлы CSS. Подключите их в базовом шаблоне.
    *   Напишите CSS-правила для стилизации форм регистрации и входа, а также для стилизации навигационной панели и других элементов ваших страниц (homepage, about, articles list).
    *   Убедитесь, что представления `homepage`, `about`, `articles/article_list` и `articles/article_detail` (если есть) имеют осмысленное наполнение (текст, заголовки и т.п.).
    *   Сделайте **скриншоты нескольких стилизованных страниц** (например, стилизованная страница входа, стилизованная страница статей с навигацией).

17. **1.16 Создание репозитория GitHub:**
    *   Перейдите на GitHub и создайте новый репозиторий с именем `blog_609-##_FIO` (замените ## на номер вашей группы/подгруппы и FIO на ваши инициалы или фамилию). Выберите опцию инициализации с `.gitignore` для Python.
    *   Откройте терминал в корневой директории вашего *локального* проекта.
    *   Инициализируйте локальный репозиторий (если еще не сделали): `git init`
    *   Создайте или обновите `.gitignore` файл. Убедитесь, что он игнорирует `__pycache__/`, `db.sqlite3`, виртуальные окружения (например, `venv/`, `.venv/`), папки `media/` (если используете), и т.п.
    *   Добавьте файлы проекта: `git add .`
    *   Сделайте коммит: `git commit -m "Implement accounts app and related features"`
    *   Добавьте удаленный репозиторий (замените URL на URL вашего репозитория на GitHub): `git remote add origin <URL_вашего_репозитория_на_GitHub>`
    *   Отправьте изменения: `git push -u origin main` (или `master`, в зависимости от имени вашей главной ветки на GitHub).
    *   Скопируйте **ссылку на ваш репозиторий на GitHub**.

18. **Ответы на вопросы:**
    *   Откройте документацию Django и/или используйте интернет для поиска ответов на следующие вопросы:
        1.  Что такое `UserCreationForm`? (Кратко: стандартная форма Django для создания нового пользователя).
        2.  Объясните, что происходит в функции-представлении `signup_view`. (Пошагово: проверка метода запроса, создание формы с данными или пустой, валидация данных, сохранение нового пользователя, автоматический вход, редирект или отображение формы с ошибками).
        3.  Что такое `AuthenticationForm`? (Кратко: стандартная форма Django для входа существующего пользователя).
        4.  Объясните, что происходит в функциях-представлениях `login_view` и `logout_view`. (Пошагово для login: проверка метода, создание формы с данными или пустой, валидация, получение пользователя, вход, редирект или отображение формы с ошибками. Пошагово для logout: проверка метода, выход пользователя, редирект).
        5.  Почему произошла ошибка CSRF в пункте 1.7? (Отсутствовал CSRF-токен в POST-запросе формы, что является стандартной защитой Django от межсайтовой подделки запросов).
        6.  Для чего нужен атрибут `action` в форме `<form>`? (Указывает URL, на который будут отправлены данные формы при её提交).
        7.  Объясните, как работает данный код (`{% if user.is_authenticated %}`...) в шаблоне, что будет происходить «под капотом» в зависимости от действий пользователя? (Django передает объект `request.user` в контекст шаблона. Тег `{% if user.is_authenticated %}` проверяет свойство `is_authenticated` этого объекта. Если пользователь вошел в систему, это свойство `True`, и отображается блок с формой выхода. Если не вошел (анонимный пользователь), `is_authenticated` `False`, и отображается блок со ссылками на вход и регистрацию).
    *   Сформулируйте четкие ответы на каждый вопрос.

19. **Формирование отчета:**
    *   Соберите все выполненные шаги, скриншоты, ответы на вопросы и ссылку на репозиторий GitHub в единый документ (например, в формате Word или PDF).
    *   Структурируйте отчет по пунктам задания.
    *   Убедитесь, что все требуемые скриншоты присутствуют и соответствуют описанию шага.
    *   Включите ответы на все 7 вопросов.
    *   Добавьте ссылку на ваш GitHub репозиторий.

Следуя этим шагам, вы сможете выполнить все требования задания и сформировать полный отчет. Удачи!